<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <style>
        body{
            font-size: 14px;
        }
        #cas {
            display: block;
            border: 1px solid;
            margin: auto;
        }

        img {
            display: none;
        }
    </style>

    <title>操控字体的数据</title>
</head>
<body>
<div>
    <canvas id='cas'>浏览器不支持canvas</canvas>
    <div style="width:150px;margin:10px auto">
        <input type="text" name="" id="name" style="width:80px;" value="2015上海智慧城市体验周开幕">
        <img src="../img/1.jpg" alt=""><img src="../img/2.jpg" alt=""><img src="../img/3.jpg" alt=""><img
            src="../img/4.jpg" alt=""><img src="../img/5.jpg" alt=""><img src="../img/6.jpg" alt=""><img
            src="../img/7.jpg" alt=""><img src="../img/8.jpg" alt=""><img src="../img/9.jpg" alt=""><img
            src="../img/10.jpg" alt=""><img src="../img/11.jpg" alt=""><img src="../img/12.jpg" alt=""><img
            src="../img/13.jpg" alt=""><img src="../img/14.jpg" alt=""><img src="../img/15.jpg" alt=""><img
            src="../img/16.jpg" alt=""><img src="../img/17.jpg" alt=""><img src="../img/18.jpg" alt=""><img
            src="../img/19.jpg" alt=""><img src="../img/20.jpg" alt=""><img src="../img/21.jpg" alt=""><img
            src="../img/22.jpg" alt=""><img src="../img/23.jpg" alt=""><img src="../img/24.jpg" alt=""><img
            src="../img/25.jpg" alt=""><img src="../img/26.jpg" alt=""><img src="../img/27.jpg" alt=""><img
            src="../img/28.jpg" alt=""><img src="../img/29.jpg" alt=""><img src="../img/30.jpg" alt=""><img
            src="../img/31.jpg" alt=""><img src="../img/32.jpg" alt=""><img src="../img/33.jpg" alt=""><img
            src="../img/34.jpg" alt=""><img src="../img/35.jpg" alt=""><img src="../img/36.jpg" alt=""><img
            src="../img/37.jpg" alt=""><img src="../img/38.jpg" alt=""><img src="../img/39.jpg" alt=""><img
            src="../img/40.jpg" alt=""><img src="../img/41.jpg" alt=""><img src="../img/42.jpg" alt=""><img
            src="../img/43.jpg" alt=""><img src="../img/44.jpg" alt=""><img src="../img/45.jpg" alt=""><img
            src="../img/46.jpg" alt=""><img src="../img/47.jpg" alt=""><img src="../img/48.jpg" alt=""><img
            src="../img/49.jpg" alt=""><img src="../img/50.jpg" alt=""><img src="../img/51.jpg" alt=""><img
            src="../img/52.jpg" alt=""><img src="../img/53.jpg" alt=""><img src="../img/54.jpg" alt=""><img
            src="../img/55.jpg" alt=""><img src="../img/56.jpg" alt=""><img src="../img/57.jpg" alt=""><img
            src="../img/58.jpg" alt=""><img src="../img/59.jpg" alt=""><img src="../img/60.jpg" alt=""><img
            src="../img/61.jpg" alt=""><img src="../img/62.jpg" alt=""><img src="../img/63.jpg" alt=""><img
            src="../img/64.jpg" alt=""><img src="../img/65.jpg" alt=""><img src="../img/66.jpg" alt=""><img
            src="../img/67.jpg" alt=""><img src="../img/68.jpg" alt=""><img src="../img/69.jpg" alt=""><img
            src="../img/70.jpg" alt=""><img src="../img/71.jpg" alt=""><img src="../img/72.jpg" alt=""><img
            src="../img/73.jpg" alt=""><img src="../img/74.jpg" alt=""><img src="../img/75.jpg" alt=""><img
            src="../img/76.jpg" alt=""><img src="../img/77.jpg" alt=""><img src="../img/78.jpg" alt=""><img
            src="../img/79.jpg" alt=""><img src="../img/80.jpg" alt=""><img src="../img/81.jpg" alt=""><img
            src="../img/82.jpg" alt=""><img src="../img/83.jpg" alt=""><img src="../img/84.jpg" alt=""><img
            src="../img/85.jpg" alt=""><img src="../img/86.jpg" alt=""><img src="../img/87.jpg" alt=""><img
            src="../img/88.jpg" alt=""><img src="../img/89.jpg" alt=""><img src="../img/90.jpg" alt="">
    </div>
</div>
<script>
    var imgs = document.getElementsByTagName('img');
    window.onload = function(){
        canvas = document.getElementById("cas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        context = canvas.getContext('2d');
        focallength = 50;
        var dots = getimgData(document.getElementById('name').value);
        var pause = false;
        initAnimate();
        function initAnimate() {
            dots.forEach(function () {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.z = Math.random() * focallength * 2 - focallength;
                this.tx = Math.random() * canvas.width;
                this.ty = Math.random() * canvas.height;
                this.tz = Math.random() * focallength * 2 - focallength;
                this.img = imgs[parseInt(Math.random() * 43)];
                this.paint();
            });
            animate();
        }

        //计算帧速率
        var lastTime;
        var derection = true;

        function animate() {
            animateRunning = true;
            var thisTime = +new Date();
            context.clearRect(0, 0, canvas.width, canvas.height);
            dots.forEach(function () {
                var dot = this;
                if (derection) {
                    if (Math.abs(dot.dx - dot.x) < 0.1 && Math.abs(dot.dy - dot.y) < 0.1 && Math.abs(dot.dz - dot.z) < 0.1) {
                        dot.x = dot.dx;
                        dot.y = dot.dy;
                        dot.z = dot.dz;
                        //if (thisTime - lastTime > 300) {
                            derection = false;
                        //}
                    } else {
                        dot.x = dot.x + (dot.dx - dot.x) * 0.02;
                        dot.y = dot.y + (dot.dy - dot.y) * 0.02;
                        dot.z = dot.z + (dot.dz - dot.z) * 0.02;
                        lastTime = +new Date();
                    }
                }
                dot.paint();
            });
            if (!pause) {
                if ("requestAnimationFrame" in window) {
                    requestAnimationFrame(animate);
                }
                else if ("webkitRequestAnimationFrame" in window) {
                    webkitRequestAnimationFrame(animate);
                }
                else if ("msRequestAnimationFrame" in window) {
                    msRequestAnimationFrame(animate);
                }
                else if ("mozRequestAnimationFrame" in window) {
                    mozRequestAnimationFrame(animate);
                }
            }
        }
    }
    Array.prototype.forEach = function (callback) {
        for (var i = 0; i < this.length; i++) {
            callback.call(this[i]);
        }
    }
    function getimgData(text) {
        drawText(text);
        var imgData = context.getImageData(0, 0, canvas.width, canvas.height);
        context.clearRect(0, 0, canvas.width, canvas.height);
        var dots = [];
        for (var x = 0; x < imgData.width; x += 6) {
            for (var y = 0; y < imgData.height; y += 6) {
                var i = (y * imgData.width + x) * 4;
                if (imgData.data[i] >= 128) {
                    var dot = new Dot(x - 3, y - 3, 0, parseInt(canvas.width/15/9));
                    dots.push(dot);
                }
            }
        }
        return dots;
    }
    function drawText(text) {
//        1400/2048
        context.save();
        var fs = parseInt(canvas.width/15);
        context.font = fs + "px 微软雅黑 bold";
        context.fillStyle = "rgba(168,168,168,1)";
        context.textAlign = "center";
        context.textBaseline = "middle";
        context.fillText(text, canvas.width / 2, canvas.height / 2);
        context.restore();
    }
    var Dot = function (centerX, centerY, centerZ, radius) {
        this.dx = centerX;
        this.dy = centerY;
        this.dz = centerZ;
        this.tx = 0;
        this.ty = 0;
        this.tz = 0;
        this.z = centerZ;
        this.x = centerX;
        this.y = centerY;
        this.radius = radius;
    }
    Dot.prototype = {
        paint: function () {
            context.save();
            context.beginPath();
            var srcale = focallength / (focallength + this.z);
            var x1 = canvas.width / 2 + (this.x - canvas.width / 2) * srcale;
            var y1 = canvas.height / 2 + (this.y - canvas.height / 2) * srcale;
            context.drawImage(this.img,x1 , y1,this.radius * srcale,this.radius * srcale);
            context.restore();
        }
    }
</script>
</body>
</html>