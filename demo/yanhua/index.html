<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2015上海智慧城市体验周启动方式</title>
    <style>
        body,canvas,img{
            padding: 0;
            margin: 0;
        }
        img{
            display: none;
        }
    </style>
</head>
<body>
<canvas id="cas" style="background-color:rgba(0,5,24,1)" width="1416" height="677">浏览器不支持canvas</canvas>
<div class="city"><img src="city.png" alt=""></div>
<img src="moon.png" alt="" id="moon" style="visibility: hidden;">

<div style="display:none">
    <div class="shape" id="kaishi">XX年会开始</div>
    <div class="shape">合家幸福</div>
    <div class="shape">万事如意</div>
    <div class="shape">心想事成</div>
    <div class="shape">财源广进</div>
</div>
<script>
        var canvas = document.getElementById("cas");
        var ocas = document.createElement("canvas");
        var octx = ocas.getContext("2d");
        var ctx = canvas.getContext("2d");
        ocas.width = canvas.width = window.innerWidth;
        ocas.height = canvas.height = window.innerHeight;
        var bigbooms = [];

        window.onload = function (){
            initAnimate()
        }

        function initAnimate() {
            lastTime = new Date();
            animate();
        }

        var lastTime;
        function animate() {
            //画一个黑色的背景
            ctx.save();
            ctx.fillStyle = "rgba(0,5,24,0.1)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();

            var newTime = new Date();
            //一一个合适的时间差内
            if (newTime - lastTime > (window.innerHeight +233)) {
                //x轴从屏幕的1/5到4/5处
                var x = getRandom(canvas.width / 5, canvas.width * 4 / 5);
                //y轴从50到200
                var y = getRandom(50, 200);
                var bigboom = new Boom(getRandom(canvas.width / 3, canvas.width * 2 / 3), 2, "#FFF", {
                    x: canvas.width / 2,
                    y: 200
                }, document.getElementById('kaishi'));
                bigbooms.push(bigboom)
                lastTime = newTime;
            }
            bigbooms.foreach(function (index) {
                var that = this;
                if (!this.dead) {
                    this._move();
                    this._drawLight();
                }else {
                    this.booms.foreach(function (index) {
                        if (!this.dead) {
                            this.moveTo(index);
                        }else if (index === that.booms.length - 1) {
                            bigbooms[bigbooms.indexOf(that)] = null;
                        }
                    })
                }
            });

            raf(animate);
        }
        //重写数组的循环
        Array.prototype.foreach = function (callback) {
            for (var i = 0; i < this.length; i++) {
                if (this[i] !== null){
                    callback.apply(this[i], [i]);
                }
            }
        }
        //动画贞
        var raf = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
        //没有爆炸的烟花
        var Boom = function (x, r, c, boomArea, shape) {
            this.booms = [];
            this.x = x;
            this.y = (canvas.height + r);
            this.r = r;
            this.c = c;
            this.shape = shape || false;
            this.boomArea = boomArea;
            this.theta = 0;
            this.dead = false;
            this.ba = parseInt(getRandom(80, 200));
        }
        Boom.prototype = {
            //画烟花
            _paint: function () {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
                ctx.fillStyle = this.c;
                ctx.fill();
                ctx.restore();
            },
            //向上移动
            _move: function () {
                var dx = this.boomArea.x - this.x,
                        dy = this.boomArea.y - this.y;

                this.x = this.x + dx * 0.01;
                this.y = this.y + dy * 0.01;

                if (Math.abs(dx) <= this.ba && Math.abs(dy) <= this.ba) {
                    this._shapBoom();
                    this.dead = true;
                }else {
                    this._paint();
                }
            },

            _drawLight: function () {
                ctx.save();
                ctx.fillStyle = "rgba(255,228,150,0.3)";
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r + 3 * Math.random() + 1, 0, 2 * Math.PI);
                ctx.fill();
                ctx.restore();
            },
            //写文字
            _shapBoom: function () {
                var that = this;
                putValue(ocas, octx, this.shape, 5, function (dots) {
                    console.log(dots);
                    var dx = canvas.width / 2 - that.x;
                    var dy = canvas.height / 2 - that.y;
                    for (var i = 0; i < dots.length; i++) {
                        color = {a: dots[i].a, b: dots[i].b, c: dots[i].c}
                        var x = dots[i].x;
                        var y = dots[i].y;
                        var radius = 1;
                        var frag = new Frag(that.x, that.y, radius, color, x - dx, y - dy);
                        that.booms.push(frag);
                    }
                })
            }
        }
        //把文字放入烟花中
        function putValue(canvas, context, ele, dr, callback) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            var img = new Image();
            if (ele.innerHTML.indexOf("img") >= 0) {
                img.src = ele.getElementsByTagName("img")[0].src;
                imgload(img, function () {
                    context.drawImage(img, canvas.width / 2 - img.width / 2, canvas.height / 2 - img.width / 2);
                    dots = getimgData(canvas, context, dr);
                    callback(dots);
                })
            }else {
                var text = ele.innerHTML;
                context.save();
                var fontSize = 200;
                context.font = fontSize + "px 宋体 bold";
                context.textAlign = "center";
                context.textBaseline = "middle";
                context.fillStyle = "rgba(" + parseInt(getRandom(128, 255)) + "," + parseInt(getRandom(128, 255)) + "," + parseInt(getRandom(128, 255)) + " , 1)";
                context.fillText(text, canvas.width / 2, canvas.height / 2);
                context.restore();
                dots = getimgData(canvas, context, dr);
                callback(dots);
            }
        }
        //加载图片
        function imgload(img, callback) {
            if (img.complete) {
                callback.call(img);
            }else {
                img.onload = function () {
                    callback.call(this);
                }
            }
        }
        //获取文字的像素点的位置
        function getimgData(canvas, context, dr) {
            var imgData = context.getImageData(0, 0, canvas.width, canvas.height);
            context.clearRect(0, 0, canvas.width, canvas.height);
            var dots = [];
            for (var x = 0; x < imgData.width; x += dr) {
                for (var y = 0; y < imgData.height; y += dr) {
                    var i = (y * imgData.width + x) * 4;
                    if (imgData.data[i + 3] > 128) {
                        var dot = {x: x, y: y, a: imgData.data[i], b: imgData.data[i + 1], c: imgData.data[i + 2]};
                        dots.push(dot);
                    }
                }
            }
            return dots;
        }
        //获取a到b的随机数
        function getRandom(a, b) {
            return Math.random() * (b - a) + a;
        }

        //爆炸后的小花
        var Frag = function (centerX, centerY, radius, color, tx, ty) {
            this.tx = tx;
            this.ty = ty;
            this.x = centerX;
            this.y = centerY;
            this.dead = false;
            this.centerX = centerX;
            this.centerY = centerY;
            this.radius = radius;
            this.color = color;
        }

        Frag.prototype = {
            //画烟花的碎花
            paint: function () {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
                ctx.fillStyle = "rgba(" + this.color.a + "," + this.color.b + "," + this.color.c + ",1)";
                ctx.fill()
                ctx.restore();
            },
            //移动碎花
            moveTo: function (index) {
                this.ty = this.ty + 0.3;
                var dx = this.tx - this.x, dy = this.ty - this.y;
                this.x = Math.abs(dx) < 0.1 ? this.tx : (this.x + dx * 0.1);
                this.y = Math.abs(dy) < 0.1 ? this.ty : (this.y + dy * 0.1);
                if (dx === 0 && Math.abs(dy) <= 80) {
                    this.dead = true;
                };
                this.paint();
            }
        }
    /**
     * 首先，“2015上海xxx启动仪式”是一开始就有的背景图。接下来是领导扫码，大屏翻转，
     * 出现“智慧xxxxx生活”，过1秒钟，很多头像飞出，拼成“ 2015上海智慧城市体验周开幕 ”，
     * 烟花出现。
     */
</script>
</body>
</html>