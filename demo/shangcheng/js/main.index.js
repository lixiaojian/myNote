function time(e){if(60==wait){var t=$("#mobilephone").val();if(""==t)return void app.alert("手机号不能为空");if(!V.mobilePhone(t))return void app.alert("您输入的手机号不正确");app.user.getVerificationcode(t)}0==wait?(e.removeAttribute("disabled"),e.value="免费获取验证码",wait=60):(e.setAttribute("disabled",!0),e.value="重新发送("+wait+")",wait--,setTimeout(function(){time(e)},1e3))}function generate(){var e=$("#mobilephone").val();if(""==e)return void app.alert("手机号不能为空");if(!V.mobilePhone(e))return void app.alert("您输入的手机号不正确");var t={type:1,purpose:3,yzType:1,identifier:$("#mobilephone").val()};app.api.user.generate({data:t,success:function(e){(e.code=e.data)?app.alert("成功发送语音验证码请求,请稍等片刻"):app.alert("小主,"+e.message)},error:function(){app.alert("小主,系统繁忙,请稍后再试!")}})}!function(e){e.merchants={captureMerchantId:function(){var e="",t=window.location;return t.search.length>10&&t.search.getParameterKey("merchantid")?(e=t.search.getParameterKey("merchantid"),sessionStorage.setItem("merchantid",e)):e=sessionStorage.getItem("merchantid"),e}},e.common={captureOpendId:function(){var e="",t=window.location;return t.search.length>10&&t.search.getParameterKey("openid")?(e=t.search.getParameterKey("openid"),sessionStorage.setItem("openid",e)):e=sessionStorage.getItem("openid"),e},captureUserId:function(){return{then:function(t,n){var a=e.common.captureOpendId(),r=e.merchants.captureMerchantId();e.api.user.queryUserinfo({data:{merchantId:r,openid:a},async:!1,success:function(e){e&&e.success&&(sessionStorage.setItem("userinfo",JSON.stringify(e.data)),userinfo=e.data,t(userinfo.userId))},error:function(e){console.info(e),n("网络请求失败")}})}}},getLocation:function(){return{then:function(t,n){var a=localStorage.getItem("location");if(a)a=JSON.parse(a),t(a);else{var r=e.merchants.captureMerchantId();e.api.JSSignature.getJSSignature({data:{url:encodeURIComponent(window.location.href.split("#")[0]),token:"mei1",merchantId:r},success:function(e){wx.getLocation({type:"wgs84",success:function(e){a={latitude:e.latitude,longitude:e.longitude},localStorage.setItem("location",JSON.stringify(a)),t(a)}})},error:function(){n("网络请求失败")}})}}}},getBpoUserByCampaign:function(){return{then:function(t,n){var a=e.common.captureOpendId(),r=e.merchants.captureMerchantId();e.api.promotions.getBpoUserByCampaign({data:{merchantId:r,openid:a},async:!1,success:function(e){e&&e.success&&(sessionStorage.setItem("userinfo",JSON.stringify(e.data)),userinfo=e.data,t(userinfo.userId))},error:function(e){console.info(e),n("网络请求失败")}})}}}},e.jssdk={},e.user={getVerificationcode:function(t){e.api.user.getVerificationcode({data:{mobilephone:t},success:function(e){e&&e.success&&console.info("获取验证码成功")},error:function(e){console.info(e)}})},userbind:function(){var t=$("#mobilephone").val();if(""==t)return void e.alert("手机号不能为空");if(!V.mobilePhone(t))return void e.alert("您输入的手机号不正确");var n=$("#verifyNo").val();if(""==n)return void e.alert("验证码不能为空");var a=keyGetValue("openid"),r=keyGetValue("merchantid");if(!a||!r)return void e.alert("小主，请从菜单栏中进行绑定");e.startLoading(),e.api.user.userBinduser({data:{merchantId:r,mobilephone:t,verifyNo:n,openid:a},success:function(t){e.endLoading(),t.success?(localStorage.setItem("userinfo",JSON.stringify(t.data)),window.location.href=t.data.url):e.alert(t.message,"绑定提示")},error:function(t){e.endLoading(),e.alert("验证码输入错误"),console.info(t)}})},queryUserinfo:function(){var t=e.common.captureOpendId(),n=e.merchants.captureMerchantId();e.api.user.queryUserinfo({data:{merchantId:n,openid:t},async:!0,success:function(a){if(a&&a.success){sessionStorage.setItem("userinfo",JSON.stringify(a.data));var r=a.data;if(r.birthDay&&""!=r.birthDay){var i=r.birthDay;r.birthDay=e.tools.formatDate(i)}var o=$("#tmpl_userinfo").html(),s=tmpl(o,r);$("#show_tpl_userinfo").html(s),$('input[name="user_birthday"]').val(r.birthDay),e.api.user.userCardAndCoupon({data:{merchantid:n,openid:t},success:function(e){e&&e.success&&e.data&&(e.data.numberOfExpireTicket&&e.data.numberOfExpireTicket>0&&$("#coupon").html(e.data.numberOfExpireTicket+"张优惠券即将过期"),e.data.numberOfCards&&$("#my_card").html(e.data.numberOfCards))}})}},error:function(e){console.info(e)}})},setImagePreview:function(t){e.startLoading();var n=$(t)[0].files[0];$("#path").localResizeIMG({width:400,quality:.8,ele:t,success:function(t){console.log(t);var a=t.clearBase64,r={content:a,contentType:n.type,originalName:n.name};e.api.user.uploadFile({data:r,success:function(t){if(e.endLoading(),t.success&&t.data){var n=sessionStorage.getItem("userinfo");n=JSON.parse(n),n.avatarFileId=t.data,e.user.updateUser(n);var a=e.filePath+n.avatarFileId;$("#view").attr("src",a)}},error:function(t){e.alert("图片过大"),e.endLoading()}})}})},unUserbind:function(){e.confirm({title:"解绑提示",msg:"您确定要解除绑定吗？",center:"app.user.centerUnbind()"})},centerUnbind:function(){var t=e.common.captureOpendId();e.api.user.unbind({data:{openid:t},success:function(t){if(t&&t.success){e.alert("解除绑定成功"),setTimeout(function(){WeixinJSBridge.call("closeWindow")},800)}},error:function(e){console.info(e)}})},updateUser:function(t){var n=t.nickName;if(!n)return void e.alert("用户名不能为空");if(n.length>30)return void e.alert("姓名过长，请修改");var a=t.gender,r=t.age,i=t.birthDay;i&&(i+=" 00:00:00");var o=t.address;o&&o.length>80&&e.alert("您输入的地址过长");var s=t.signature;s&&s.length>60&&e.alert("您输入的签名过长");var c=t.avatarFileId,u=e.merchants.captureMerchantId(),d=e.common.captureOpendId(),f={openid:d,nickName:n,gender:a,address:o,ageGroup:r,signature:s,avatarFileId:c,birthDay:i,age:r};e.api.user.updateUserinfo({data:{merchantId:u,openid:d,user:f},success:function(e){e&&e.success&&(sessionStorage.setItem("userinfo",JSON.stringify(e.data)),window.location.href="/views/userinfo/index.html?openid="+keyGetValue("openid")+" &merchantid="+keyGetValue("merchantid"))},error:function(e){console.info(e)}})},edit_userinfo:function(){window.location.href="/views/userinfo/index.html?openid="+keyGetValue("openid")+"&merchantid="+keyGetValue("merchantid")}}}(app);var wait=60;